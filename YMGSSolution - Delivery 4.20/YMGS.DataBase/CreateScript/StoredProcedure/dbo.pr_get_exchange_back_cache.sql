
IF EXISTS ( SELECT  *
            FROM    sysobjects
            WHERE   id = OBJECT_ID(N'[dbo].[pr_get_exchange_back_cache]')
                    AND OBJECTPROPERTY(id, N'Isprocedure') = 1 ) 
    DROP PROCEDURE [dbo].[pr_get_exchange_back_cache]
GO
CREATE PROCEDURE [dbo].[pr_get_exchange_back_cache]
AS 

	SELECT * FROM 
	(
		SELECT ROW_NUMBER() OVER (PARTITION BY MARKET_ID ORDER BY ODDS ASC) AS TopNO,
		MATCH_ID,MARKET_ID,MATCH_TYPE,
		ODDS AS BackODDS,SUM(MATCH_AMOUNTS) BackMATCH_AMOUNTS 
		FROM 
			(
				SELECT MATCH_ID,MARKET_ID,ODDS,MATCH_AMOUNTS,MATCH_TYPE
				FROM TB_EXCHANGE_BACK 
				WHERE [STATUS]=1 AND MATCH_TYPE = 1
			) tmp
		WHERE MARKET_ID IN(SELECT MARKET_ID FROM dbo.udf_get_canuse_market_for_betting())
		GROUP BY MATCH_ID,MARKET_ID,MATCH_TYPE,ODDS
		UNION ALL
		SELECT ROW_NUMBER() OVER (PARTITION BY MARKET_ID ORDER BY ODDS DESC) AS TopNO,
		MATCH_ID,MARKET_ID,MATCH_TYPE,
		ODDS AS BackODDS,SUM(MATCH_AMOUNTS) BackMATCH_AMOUNTS 
		FROM 
			(
				SELECT MATCH_ID,MARKET_ID,ODDS,MATCH_AMOUNTS,MATCH_TYPE
				FROM TB_EXCHANGE_BACK 
				INNER JOIN TB_CHAMP_EVENT ON TB_EXCHANGE_BACK.MATCH_ID = TB_CHAMP_EVENT.Champ_Event_ID
				WHERE TB_EXCHANGE_BACK.STATUS = 1 AND MATCH_TYPE = 2 AND TB_CHAMP_EVENT.Champ_Event_Status = 1
			) tmp
		GROUP BY MATCH_ID,MARKET_ID,MATCH_TYPE,ODDS
	)t 
	WHERE t.TopNO<=3
	
	SELECT MARKET_ID,MATCH_TYPE,(sum(BET_AMOUNTS)-sum(MATCH_AMOUNTS)) AS BackDealAmount,sum(MATCH_AMOUNTS) AS BackMatchAmount 
	From TB_EXCHANGE_BACK WITH(NOLOCK)
	WHERE [STATUS] < 6
	GROUP BY MARKET_ID,MATCH_TYPE

GO
